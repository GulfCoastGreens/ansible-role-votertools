---
- name: Add gem fpm
  include: gems_fpm.yml
- name: Add composer
  include: composeroauth.yml
- name: Update composer dependencies
  composer:
    command: "{{ item }}"
    working_dir: "{{ playbook_dir }}/../"
  with_items:
    - install
    - update
- name: Build the package
  shell: "{{ item }}"
  args:
    chdir: "{{ playbook_dir }}/../"
  with_items:
    - "npm cache clean"
    - "npm prune"
    - "npm install --ignore-scripts"
    - "rm -rf bin"
    - "mkdir -p bin"
    - "vendor/bin/box build"
- name: Build the RPM package
  shell: "{{ item }}"
  args:
    chdir: "{{ playbook_dir }}/../"
  with_items:
    - "node_modules/grunt-cli/bin/grunt shell:fpmrpm"
